<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시판 로그인 페이지</title>
<meta name="viewport"
	content="user-scalable=no, initial-scale=1, maximum-scale=1,
	minimum-scale=1, width=device-width">
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">
<script type="text/javascript" src="js/jquery-1.12.4.min.js"></script>
<script>
	var REST_SERVICE_URI = 'http://192.168.0.29:8082/UML01Board/rest';
	$(document).on('pagecreate', function() {
		$('#btnLogin').unbind('click');
		$('#btnLogin').click(function(e) {
			// 기본 이벤트 동작하지 않도록 하기
			e.preventDefault();
			// form 가져오기
			var form = $('#frmLogin')[0];
			// FormData 객체 생성
			var formData = new FormData(form);
			// 두 번 실행 방지를 위해 버튼 비활성
			$('#btnLogin').prop('disabled', true);
			
			$.ajax({
				type: 'post',
				url: REST_SERVICE_URI + '/user/login',
				data: formData,
				processData: false,
				contentType: false,
				cache: false,
				success: function(data, textStatus, xhr) {
					alert(data);
					
					$('#btnLogin').prop('disabled', false);
					var location = xhr.getResponseHeader('Location');
					sessionStorage.setItem('base64Credentials', data);
					sessionStorage.setItem('location', location);
					$.mobile.changePage('home.html');
				},
				error: function(error) {
					$('#btnLogin').prop('disabled', false);
					alert(JSON.stringify(error));
				}
			});
		});
		$('#btnJoinSubmit').unbind('click');
		$('#btnJoinSubmit').click(function(e) {
			// 기본 이벤트 동작하지 않도록 하기
			e.preventDefault();
			// form 가져오기
			var form = $('#frmJoin')[0];
			// FormData 객체 생성
			var formData = new FormData(form);
			// 두 번 실행 방지를 위해 버튼 비활성
			$('#btnJoinSubmit').prop('disabled', true);
			
			$.ajax({
				type: 'post',
				url: REST_SERVICE_URI + '/user',
				enctype: 'multipart/form-data',
				data: formData,
				processData: false,
				contentType: false,
				cache: false,
				timeout: 60000,
				success: function(data, textStatus, xhr) {
					$('#btnJoinSubmit').prop('disabled', false);
					$.mobile.changePage('index.html');
				},
				error: function(error) {
					$('#btnJoinSubmit').prop('disabled', false);
					alert(error);
				}
			});
		});
	});
	$(document).on('pagechange', function() {
		var href = $(location).attr('href');
		var index = href.lastIndexOf('/');
		var currentUrl = href.substring(index);
		// 화면 분기점
		// 홈 화면
		if (currentUrl.startsWith('/home.html')) {
			$.ajax({
				type: 'get',
				url: sessionStorage.getItem('location'),
				headers: {
					authorization: 'Basic ' + sessionStorage.getItem('base64Credentials')
				},
				contentType: 'application/json',
				dataType: 'json',
				success: function(data, textStatus, xhr) {
					console.log(JSON.stringify(data));
					var location = xhr.getResponseHeader('Location');
					$('#home-email').html(data.email);
					$('#home-name').html(data.name);
					for (var i = 0; i < data.userTypes.length; i++) {
						$('#home-authority').append('<div>' + data.userTypes[i].type + '</div>');
					}
					$('#home-avatar').attr('src', location);
				},
				error: function(error) {
					alert(JSON.stringify(error));
				}
			});
		}
		// 글 목록 화면
		else if (currentUrl.startsWith('/board-list.html')) {
			$.ajax({
				type: 'get',
				url: REST_SERVICE_URI + '/board',
				headers: {
					authorization: 'Basic ' + sessionStorage.getItem('base64Credentials')
				},
				contentType: 'application/json',
				dataType: 'json',
				success: function(data, textStatus, xhr) {
					console.log(JSON.stringify(data));
					for (var i = 0; i < data.length; i++) {
						$('#board-list-listview').append("<li><a href='board/" + data[i].no + "'>" + data[i].title + "</a></li>");
					}
					$('#board-list-listview').listview('refresh');

					$('#board-list-listview li a').unbind('click');
					$('#board-list-listview li a').click(function(e){

						e.preventDefault();
						
						var href = $(this).attr('href');						
						// 게시물 상세보기 REST API 주소
						sessionStorage.setItem('location', href);						
						// 글 상세보기 페이지로 이동
						$.mobile.changePage('board-detail.html');						
					});
				},
				error: function(error) {
					alert(JSON.stringify(error));
				}
								
			});
		}
		// 글 상세 화면
		else if (currentUrl.startsWith('/board-detail.html')) {
			$.ajax({
				type: 'get',
				url: REST_SERVICE_URI + '/' + sessionStorage.getItem('location'),
				headers: {
					authorization: 'Basic ' + sessionStorage.getItem('base64Credentials')
				},
				contentType: 'application/json',
				dataType: 'json',
				success: function(data, textStatus, xhr) {
					console.log(JSON.stringify(data));	

					// 첨부파일 다운로드 주소
					var location = xhr.getResponseHeader('Location');	
					$('#board-detail-no').html(data.no);
					$('#board-detail-name').html(data.userInfo.name);
					$('#board-detail-regdate').html(new Date(data.regdate).toLocaleDateString('ko-KR', {timezone:'Asia/Seoul'}));
					$('#board-detail-title').html(data.title);
					$('#board-detail-content').html(data.content);
					$('#board-detail-attachment').attr('href', location).html(data.attachment);
				} 
					error: function(error) {
						alert(JSON.stringify(error));
				}
								
			});
		}
	});
</script>
<script type="text/javascript" src="js/jquery.mobile-1.4.5.js"></script>
</head>
<body>
	<div data-role="page">
		<div data-role="header">
			<h1>게시판 로그인</h1>
		</div>
		<div data-role="content">
			<form method="post" id="frmLogin">
				<div data-role="fieldcontain">
					<label for="email">이메일</label>
					<input type="email" name="email" id="email">
				</div>
				<div data-role="fieldcontain">
					<label for="password">비밀번호</label>
					<input type="password" name="password" id="password">
				</div>
				
				<div class="ui-grid-a">
					<div class="ui-block-a">
						<a href="join.html" data-role="button" id="btnJoin">회원 가입</a>
					</div>
					<div class="ui-block-b">
						<a href="#" data-role="button" id="btnLogin">로그인</a>
					</div>
				</div>
			</form>
		</div>
	</div>
</body>
</html>